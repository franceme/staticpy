#References
#* https://github.com/quadratichq/quadratic/issues/416
name=quadratic
default:: full

dockerfile:
	echo "FROM rust:latest">>Dockerfile
	echo "RUN apt-get update">>Dockerfile
	echo "RUN apt-get install -y npm">>Dockerfile
	echo "RUN curl https://rustwasm.github.io/wasm-pack/installer/init -sSf | sh">>Dockerfile
	echo "RUN rustup target add wasm32-unknown-unknown">>Dockerfile
	echo "COPY package*.json ./">>Dockerfile
	echo "COPY . .">>Dockerfile
	echo "RUN npm run build:wasm">>Dockerfile
	echo "RUN npm install">>Dockerfile
	echo "CMD [\"npm\", \"start\"]">>Dockerfile
download:
	wget https://github.com/quadratichq/quadratic/archive/d6e9b05952d26eb7130cd308e8fa0cb805c7734e.zip
	7z x *.zip 
	rm *.zip
	mv $(name)-* $(name)
	if test -d $(name)/;then echo exists;else make dockerfile;fi
	cp Dockerfile $(name)/
build:
	if test -d $(name)/;then echo exists;else make download;fi
	cd $(name)/ && docker build -t $(name) --platform=linux/amd64 .
run:
	cd $(name)/ && docker run --platform linux/amd64 -p 3000:3000 $(name)

full:build run


# Builds
#Latest (Doesn't work):https://github.com/quadratichq/quadratic/archive/refs/heads/main.zip
#Right Before License Change:https://github.com/quadratichq/quadratic/archive/d6e9b05952d26eb7130cd308e8fa0cb805c7734e.zip
#User Created Dockerfile:https://github.com/irjensen/quadratic/archive/30e11ae44625059b722150d70559491596c92b6c.zip
